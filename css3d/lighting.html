<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <title>ThreeJS Lighting</title>
        <script src="../thirdparty/jquery-2.0.3.min.js"></script>
        <script src="../thirdparty/greensock/TweenMax.min.js"></script>
        <script src="../thirdparty/stats.min.js"></script>
        <script src="../thirdparty/threejs/build/three.min.js"></script>
        <script src="../thirdparty/threejs/build/three.min.js"></script>
        <script src="../thirdparty/threejs/build/TrackballControls.js"></script>
        <script src="../thirdparty/threejs/build/CSS3DRenderer.js"></script>
        <script src="../thirdparty/photon.min.js"></script>
        <script>
            window.onload = function () {
              init();
            };

            var camera;
            var scene;
            var webglRenderer;
            var css3dRenderer;
            var renderer;
            var stats;
            var controls;
            var groups = [];
            var light;
            var lightFaces = [];

            var init = function () {

              webglRenderer = new THREE.WebGLRenderer();
              webglRenderer.setClearColor(0xffffff, 1);
              webglRenderer.setSize( window.innerWidth, window.innerHeight );

              css3dRenderer = new THREE.CSS3DRenderer();
              css3dRenderer.setSize( window.innerWidth, window.innerHeight );

              renderer = css3dRenderer//webglRenderer;
              document.body.appendChild( renderer.domElement );

              camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 1000 );
              camera.position.x = 0;
              camera.position.y = 100;
              camera.position.z = 350;

              light = new Photon.Light(x = 45, y = -180, z = 100);

              //
              var loader = new THREE.ObjectLoader();
              loader.load( "../data/scene-css.json", callbackFinished );

              //
              stats = new Stats();
              stats.domElement.style.position = 'absolute';
              stats.domElement.style.top = '0px';
              stats.domElement.style.zIndex = 100;
              document.body.appendChild( stats.domElement );

              controls = new THREE.TrackballControls( camera );
              controls.rotateSpeed = 1.0;
              controls.zoomSpeed = 1.2;
              controls.panSpeed = 0.8;

              controls.noZoom = false;
              controls.noPan = false;
              controls.minDistance = 200;
              controls.maxDistance = 1200;

              controls.staticMoving = true;
              controls.dynamicDampingFactor = 0.3;

              controls.keys = [ 65, 83, 68 ];

              controls.addEventListener( 'change', render );

              //
              $(window).resize(resize);
            }

            var createCSS3DObject = function ( mesh ) {
              var groupName = mesh.userData['group'];

              var dom = document.createElement( 'div' );
              dom.className = (groupName ? groupName + ' ' : '') + mesh.name + ' shadable';
              dom.style.width = mesh.geometry.width + 'px';
              dom.style.height = mesh.geometry.height + 'px';
              dom.style.backgroundColor = '#'+mesh.material.color.getHexString();

              var object = new THREE.CSS3DObject( dom );
              object.position = mesh.position;
              object.rotation = mesh.rotation;

              scene.add( object );

              if(groupName) {
                var group = addToGroup(object, groupName);
                scene.add( group );
              }

              return object;
            }

            var createCSS3DSprite = function ( sprite ) {
              var spriteName = sprite.name;

              var dom = document.createElement( 'div' );
              dom.style.backgroundColor = '#'+sprite.material.color.getHexString();
              dom.className = 'sprite ' + (spriteName || '');
              dom.setAttribute('data-name', spriteName);

              var object = new THREE.CSS3DSprite( dom );
              object.position = sprite.position;

              scene.add( object );

              dom.addEventListener('click', onClickSprite);

              return object;
            }

            var addToGroup = function ( css3dObject, groupName ) {
              var group = scene.getObjectByName(groupName);

              if(!group) {
                group = new THREE.Object3D();
                group.name = groupName;
                groups.push(group);
              }

              group.add(css3dObject);

              return group;
            };

            var callbackFinished = function ( result ) {
              scene = result;

              var children = scene.children.concat();
              var l = children.length;
              for(var i = 0; i < l; ++i) {
                var child = children[i];
                if(child instanceof THREE.Mesh) {
                  createCSS3DObject( child );
                }else if(child instanceof THREE.Sprite) {
                  createCSS3DSprite( child );
                }
              }

              animate();

              var shadableDoms = $('.shadable');
              var l = shadableDoms.length;
              for(var i = 0; i < l; ++i) {
                var dom = shadableDoms[i];
                var face = new Photon.Face( dom, .5, .5, true );
                lightFaces.push( face );
              }
            };

            var render = function () {
              renderer.render(scene, camera);
            }

            var animate = function () {
              requestAnimationFrame( animate );

              var time = Date.now() * 0.0004;

              for(var i = 0; i < groups.length; ++i) {
                var group = groups[i];
                group.rotation.y = time * 0.7;
              }

              for(var i = 0; i < lightFaces.length; ++i) {
                var face = lightFaces[i];
                face.render(light, true);
              }

              controls.update();
              
              render();

              stats.update();
            }

            var resize = function () {

              camera.aspect = window.innerWidth / window.innerHeight;
              camera.updateProjectionMatrix();

              renderer.setSize( window.innerWidth, window.innerHeight );

              controls.handleResize();

              render();
            }

            var onClickSprite = function (e) {
              var spriteName = e.currentTarget.getAttribute('data-name');              
              var sprite = scene.getObjectByName(spriteName);

              console.log(camera);
            }
        </script>

        <style media="screen">
            body{
              background-color: #ffffff;
              margin: 0;
              overflow: hidden;
              font-family: sans-serif;
            }

            .sprite{
              width: 20px;
              height: 20px;
              cursor: pointer;
            }
        </style>
    </head>
    <body>
    </body>
    </html>